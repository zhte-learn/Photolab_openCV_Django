{% extends "base.html" %}

{% block title %}
  Object Annotation
{% endblock %}

{% block content %}
    <h2 class="mb-4">Annotate objects</h2>
    
    <div class="d-flex gap-2 mb-3 align-items-center">
        <button id="undoBtn" class="btn btn-primary" style="width: 150px;">Undo</button>
        <button id="deleteBtn" class="btn btn-primary" style="width: 150px;">Remove all</button>
        <input type="color" id="colorPicker" value="#00ff00" class="form-control form-control-color">
        <input type="text" id="labelInput" placeholder="Enter label" class="form-control" style="width: 250px;">
    </div>

    <div id="canvas-container">
        <canvas id="canvas"></canvas>
    </div>

    <div class="d-flex gap-2 mb-3 align-items-center justify-content-left mt-3">
        <button id="saveBtn" class="btn btn-primary w-25">Save to CSV</button>
    </div>

    <style>
        #canvas-container {
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: auto;
            position: relative;
        }

        canvas {
            display: block;
            max-width: 100%;
            height: auto;
        }
    </style>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();

        img.src = "{{ original }}";

        const rectangles = [];
        let isDrawing = false;
        let startX = 0, startY = 0;

        img.onload = () => {
            const maxWidth = window.innerWidth * 0.95;
            const maxHeight = window.innerHeight * 0.9;
            const scale = Math.min(maxWidth / img.width, maxHeight / img.height, 1);

            canvas.width = img.width;
            canvas.height = img.height;

            canvas.style.width = img.width * scale + 'px';
            canvas.style.height = img.height * scale + 'px';

            drawAll();
        };

        function getMousePos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            return {
                x: (evt.clientX - rect.left) * scaleX,
                y: (evt.clientY - rect.top) * scaleY
            };
        }

        function drawAll(tempRect = null) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);

            rectangles.forEach(r => {
                ctx.strokeStyle = r.color;
                ctx.lineWidth = 3;
                ctx.strokeRect(r.x, r.y, r.w, r.h);

                if (r.label) {
                    ctx.font = "16px Arial";
                    ctx.fillStyle = r.color;
                    ctx.fillText(r.label, r.x + r.w + 5, r.y + 20);
                }
            });

            if (tempRect) {
                ctx.strokeStyle = tempRect.color;
                ctx.lineWidth = 2;
                ctx.strokeRect(tempRect.x, tempRect.y, tempRect.w, tempRect.h);

                if (tempRect.label) {
                    ctx.font = "16px Arial";
                    ctx.fillStyle = tempRect.color;
                    ctx.fillText(tempRect.label, tempRect.x + tempRect.w + 5, tempRect.y + 20);
                }
            }
        }

        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            const pos = getMousePos(canvas, e);
            startX = pos.x;
            startY = pos.y;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            const pos = getMousePos(canvas, e);
            const x = Math.min(startX, pos.x);
            const y = Math.min(startY, pos.y);
            const w = Math.abs(pos.x - startX);
            const h = Math.abs(pos.y - startY);

            drawAll({
                x, y, w, h,
                color: document.getElementById('colorPicker').value,
                label: document.getElementById('labelInput').value.trim()
            });
        });

        canvas.addEventListener('mouseup', (e) => {
            if (!isDrawing) return;
            isDrawing = false;

            const pos = getMousePos(canvas, e);
            const x = Math.min(startX, pos.x);
            const y = Math.min(startY, pos.y);
            const w = Math.abs(pos.x - startX);
            const h = Math.abs(pos.y - startY);

            rectangles.push({
                x, y, w, h,
                color: document.getElementById('colorPicker').value,
                label: document.getElementById('labelInput').value.trim()
            });
            drawAll();
        });

        document.getElementById('undoBtn').addEventListener('click', () => {
            if (rectangles.length > 0) {
                rectangles.pop();
                drawAll();
            }
        });

        document.getElementById('deleteBtn').addEventListener('click', () => {
            rectangles.length = 0;
            drawAll();
        });

        {% comment %} document.getElementById('saveBtn').addEventListener('click', () => {
            if (rectangles.length === 0) return alert("No annotations to save.");

            const imageUrl = "{{ original }}";
            const imageNameWithExt = imageUrl.split('/').pop();
            const imageName = imageNameWithExt.split('.').slice(0, -1).join('.');

            const data = {
                image_name: imageNameWithExt,
                annotations: rectangles.map(r => ({
                    label: r.label,
                    x: Math.round(r.x),
                    y: Math.round(r.y),
                    width: Math.round(r.w),
                    height: Math.round(r.h),
                    color: r.color
                }))
            };

            fetch('/save_annotations/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (response.ok) {
                    alert("Annotations saved successfully!");
                    document.getElementById('labelInput').value = '';
                } else {
                    alert("Failed to save annotations.");
                }
            })
            .catch(err => alert("Error: " + err));
        }); {% endcomment %}
    </script>
{% endblock %}
